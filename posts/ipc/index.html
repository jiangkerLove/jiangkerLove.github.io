<!DOCTYPE html>
<html lang="en">

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Allow having a localized datetime different from the appearance language -->
  

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="Android进程通信">
<meta name="author" content="jiangker">
<meta property="og:locale" content="en">
<meta name="description" content="Android多进程">
<meta property="og:description" content="Android多进程">
<link rel="canonical" href="http://0.0.0.0:4000/posts/ipc/">
<meta property="og:url" content="http://0.0.0.0:4000/posts/ipc/">
<meta property="og:site_name" content="Jiangker">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-11-11T18:38:00+08:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Android进程通信">
<meta name="twitter:site" content="@twitter_username">
<meta name="twitter:creator" content="@jiangker">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"jiangker"},"dateModified":"2023-08-30T15:38:16+08:00","datePublished":"2022-11-11T18:38:00+08:00","description":"Android多进程","headline":"Android进程通信","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/posts/ipc/"},"url":"http://0.0.0.0:4000/posts/ipc/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Android进程通信 | Jiangker
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Jiangker">
<meta name="application-name" content="Jiangker">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net">
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&amp;display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  
</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="/assets/img/avatar.jpeg" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Jiangker</a>
    </div>
    <div class="site-subtitle font-italic">record coding learning</div>

  </div>
<!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
      <a href="javascript:location.href%20=%20'mailto:'%20+%20%5B'niklaus1996','icloud.com'%5D.join('@')" aria-label="email">
        <i class="fas fa-envelope"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div>
<!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>Android进程通信</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel">Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">

        









<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->



<!-- images -->




  
  

  
    
      
      
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







<!-- return -->





<h1 data-toc-skip>Android进程通信</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="" data-ts="1668163080" data-df="ll" data-toggle="tooltip" data-placement="bottom">
  Nov 11, 2022
</em>

    </span>

    <!-- lastmod date -->
    
    <span>
      Updated
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="" data-ts="1693381096" data-df="ll" data-toggle="tooltip" data-placement="bottom">
  Aug 30, 2023
</em>

    </span>
    

  

  <div class="d-flex justify-content-between">
    <!-- author -->
    <span>
      
      

      

      By

      <em>
        
        jiangker
        
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3524 words">
  <em>19 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <h1 id="android多进程">Android多进程</h1>

<h2 id="为什么要使用多进程">
<span class="mr-2">为什么要使用多进程</span><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%BF%9B%E7%A8%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<ul>
  <li>
    <p>系统为App每一个进程分配的内存是有限的，超过系统分配的内存上限就会出现OOM。</p>
  </li>
  <li>
    <p>当加载比较大的图片预览时</p>
  </li>
  <li>
    <p>后台播放音乐</p>
  </li>
</ul>

<h2 id="开启多进程模式">
<span class="mr-2">开启多进程模式</span><a href="#%E5%BC%80%E5%90%AF%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%BC%8F" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<ul>
  <li>单个应用使用多进程只有一种方法，那就是给四大组件在AndroiMenifest中指定<code class="language-plaintext highlighter-rouge">android:process</code>属性。另外还有就是可以通过JNI的native层去fork一个新的进程。</li>
  <li>如果没有特别的指定运行的进程，那么运行的进程名字为自己的包名<package></package>
</li>
  <li>若设置<code class="language-plaintext highlighter-rouge">android:process=":remote"</code>,”:”的含义是指要在当前的进程名前加上当前的包名，则进程名为 <code class="language-plaintext highlighter-rouge">&lt;package&gt;:remote</code>,并且以”:”开头的进程属于当前应用的私有进程。</li>
  <li>若设置为别的形式，例如<code class="language-plaintext highlighter-rouge">com.jiangker.process</code>，则这种进程为全局进程，其他应用可以通过ShareUID的方式可以和它跑到同一个进程中。Android系统会为每个应用分配一个唯一的UID，具有相同UID的应用才能共享数据。</li>
</ul>

<h2 id="多进程带来的问题">
<span class="mr-2">多进程带来的问题</span><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h4 id="1-静态成员和单例模式完全失效">
<span class="mr-2">1 静态成员和单例模式完全失效</span><a href="#1-%E9%9D%99%E6%80%81%E6%88%90%E5%91%98%E5%92%8C%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E5%AE%8C%E5%85%A8%E5%A4%B1%E6%95%88" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<p>因为Android系统给每一个应用都分配了一个独立的虚拟机，所以内存空间是不相同的，所以不能通过内存来共享数据。</p>
<h4 id="2-线程同步机制完全失效">
<span class="mr-2">2 线程同步机制完全失效</span><a href="#2-%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6%E5%AE%8C%E5%85%A8%E5%A4%B1%E6%95%88" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<p>线程中的同步机制作用于的是同一个对象，因为不是在一个进程中了，对象也不相同了，所以不能使用</p>
<h4 id="3-sharedpreferences的可靠性下降">
<span class="mr-2">3 SharedPreferences的可靠性下降</span><a href="#3-sharedpreferences%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%B8%8B%E9%99%8D" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<p>SharedPreferences不支持多个进程去同时读写xml文件，否则会导致一定几率的数据丢失。</p>
<h4 id="4-application会多次创建">
<span class="mr-2">4 Application会多次创建</span><a href="#4-application%E4%BC%9A%E5%A4%9A%E6%AC%A1%E5%88%9B%E5%BB%BA" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>

<h2 id="多进程的通信方式">
<span class="mr-2">多进程的通信方式</span><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="linux经典进程间通信方式">
<span class="mr-2">Linux经典进程间通信方式</span><a href="#linux%E7%BB%8F%E5%85%B8%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>共享内存（Shared Memory）</li>
  <li>管道（Pipe）</li>
  <li>UNIX Domain Socket</li>
</ul>

<h3 id="android中常用进程通信方式">
<span class="mr-2">Android中常用进程通信方式</span><a href="#android%E4%B8%AD%E5%B8%B8%E7%94%A8%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>Intent 、Bundle ：要求传递数据能被序列化，实现 Parcelable、Serializable ，适用于四大组件通信。</li>
  <li>文件共享 ：适用于交换简单的数据实时性不高的场景。</li>
  <li>AIDL：AIDL 接口实质上是系统提供给我们可以方便实现 BInder 的工具。</li>
  <li>Messenger：基于 AIDL 实现，服务端串行处理，主要用于传递消息，适用于低并发一对多通信。</li>
  <li>ContentProvider：基于 Binder 实现，适用于一对多进程间数据共享。（通讯录 短信 等）</li>
  <li>Socket：TCP、UDP，适用于网络数据交换</li>
</ul>

<h1 id="binder的通信过程">Binder的通信过程</h1>

<ol>
  <li>server在SM容器中注册、</li>
  <li>Client若要调用Server的add方法，就需要先获取server对象，但是SM不会把真正的server对象返回给Client，而是把Server的一个代理对象Proxy返回给Client。</li>
  <li>Client调用Proxy的add方法，ServiceManager会帮它去调用Server的add方法，并把结果返回给Client</li>
</ol>

<h1 id="aidl跨进程通信">AIDL跨进程通信</h1>

<h2 id="1-默认支持的数据类型">
<span class="mr-2">1 默认支持的数据类型</span><a href="#1-%E9%BB%98%E8%AE%A4%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<ul>
  <li>Java中的八种基本数据类型，包括 byte，short，int，long，float，double，boolean，char。</li>
  <li>String类型和CharSequence类型。</li>
  <li>List类型：只支持ArrayList，里面的每个元素都必须要被AIDL支持；</li>
  <li>Map类型：只支持HashMap，里面的每个元素都必须要被AIDL支持，包括key和value；</li>
  <li>Parcelable：所有实现了Parcelable接口的对象；</li>
  <li>AIDL：所有的AIDL接口本身也可以在AIDL文件中使用</li>
</ul>

<blockquote>
  <p>其中自定义的Parcelable对象和AIDL对象必须要显示的import进来</p>
</blockquote>

<h2 id="2-in-out-inout的区别">
<span class="mr-2">2 in out inout的区别</span><a href="#2-in-out-inout%E7%9A%84%E5%8C%BA%E5%88%AB" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>AIDL中的定向 tag 表示了在跨进程通信中数据的流向，其中in表示数据只能由客户端流向服务端，out表示数据只能由服务端流向客户端，而 inout 则表示数据可在服务端与客户端之间双向流通。其中，数据流向是针对在客户端中的那个传入方法的对象而言的。in 为定向 tag 的话表现为服务端将会接收到一个那个对象的完整数据，但是客户端的那个对象不会因为服务端对传参的修改而发生变动；out 的话表现为服务端将会接收到那个对象的参数为空的对象，但是在服务端对接收到的空对象有任何修改之后客户端将会同步变动；inout 为定向 tag 的情况下，服务端将会接收到客户端传来对象的完整信息，并且客户端将会同步服务端对该对象的任何变动。</p>

<h2 id="3-使用示例">
<span class="mr-2">3 使用示例</span><a href="#3-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="31-aidl文件的定义">
<span class="mr-2">3.1 AIDL文件的定义</span><a href="#31-aidl%E6%96%87%E4%BB%B6%E7%9A%84%E5%AE%9A%E4%B9%89" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>aidl文件路径下</p>
<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="c1">//Book.aidl</span>
<span class="kn">package</span> <span class="nn">com.jiangker.testitem.lib</span><span class="o">;</span>

<span class="n">parcelable</span> <span class="nc">Book</span><span class="o">;</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>对应java文件路径下</p>
<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
<td class="rouge-code"><pre><span class="c1">//Book.java</span>
<span class="kn">package</span> <span class="nn">com.jiangker.testitem.lib</span>

<span class="kn">import</span> <span class="nn">android.os.Parcel</span>
<span class="kn">import</span> <span class="nn">android.os.Parcelable</span>

 <span class="kd">class</span> <span class="nf">Book</span><span class="o">(</span>
    <span class="kt">var</span> <span class="nl">name:</span> <span class="nc">String</span><span class="o">?,</span>
    <span class="kt">var</span> <span class="nl">price:</span> <span class="nc">Int</span>
<span class="o">)</span> <span class="o">:</span> <span class="nc">Parcelable</span> <span class="o">{</span>
    <span class="n">constructor</span><span class="o">(</span><span class="nl">parcel:</span> <span class="nc">Parcel</span><span class="o">)</span> <span class="o">:</span> <span class="k">this</span><span class="o">(</span>
        <span class="n">parcel</span><span class="o">.</span><span class="na">readString</span><span class="o">(),</span>
        <span class="n">parcel</span><span class="o">.</span><span class="na">readInt</span><span class="o">()</span>
    <span class="o">)</span>

    <span class="n">override</span> <span class="n">fun</span> <span class="nf">writeToParcel</span><span class="o">(</span><span class="nl">parcel:</span> <span class="nc">Parcel</span><span class="o">,</span> <span class="nl">flags:</span> <span class="nc">Int</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parcel</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
        <span class="n">parcel</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">price</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">override</span> <span class="n">fun</span> <span class="nf">describeContents</span><span class="o">():</span> <span class="nc">Int</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="o">}</span>

    <span class="n">companion</span> <span class="n">object</span> <span class="no">CREATOR</span> <span class="o">:</span> <span class="nc">Parcelable</span><span class="o">.</span><span class="na">Creator</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="n">override</span> <span class="n">fun</span> <span class="nf">createFromParcel</span><span class="o">(</span><span class="nl">parcel:</span> <span class="nc">Parcel</span><span class="o">):</span> <span class="nc">Book</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">Book</span><span class="o">(</span><span class="n">parcel</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="n">override</span> <span class="n">fun</span> <span class="nf">newArray</span><span class="o">(</span><span class="nl">size:</span> <span class="nc">Int</span><span class="o">):</span> <span class="nc">Array</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">?&gt;</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">arrayOfNulls</span><span class="o">(</span><span class="n">size</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>AIDL接口定义</p>
<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="c1">//IBookManager.aidl</span>
<span class="kn">package</span> <span class="nn">com.jiangker.testitem.lib</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.jiangker.testitem.lib.Book</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">IBookManager</span><span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBookList</span><span class="o">();</span>
    <span class="kt">void</span> <span class="nf">addBook</span><span class="o">(</span><span class="n">in</span> <span class="nc">Book</span> <span class="n">book</span><span class="o">);</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<h3 id="32-server端">
<span class="mr-2">3.2 Server端</span><a href="#32-server%E7%AB%AF" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<div class="language-kotlin highlighter-rouge">
<div class="code-header">
        <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
<td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MainService</span> <span class="p">:</span> <span class="nc">Service</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">bookLists</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">Book</span><span class="p">&gt;()</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">manager</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">IBookManager</span><span class="p">.</span><span class="nc">Stub</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">addBook</span><span class="p">(</span><span class="n">book</span><span class="p">:</span> <span class="nc">Book</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bookLists</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">getBookList</span><span class="p">():</span> <span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">Book</span><span class="p">&gt;</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">bookLists</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBind</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="nc">Intent</span><span class="p">)</span> <span class="p">=</span> <span class="n">manager</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<h3 id="33-client端">
<span class="mr-2">3.3 Client端</span><a href="#33-client%E7%AB%AF" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<div class="language-kotlin highlighter-rouge">
<div class="code-header">
        <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
<td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">var</span> <span class="py">bookService</span><span class="p">:</span> <span class="nc">IBookManager</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">connection</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">ServiceConnection</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">onServiceDisconnected</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nc">ComponentName</span><span class="p">?)</span> <span class="p">{</span>

        <span class="p">}</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">onServiceConnected</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nc">ComponentName</span><span class="p">?,</span> <span class="n">service</span><span class="p">:</span> <span class="nc">IBinder</span><span class="p">?)</span> <span class="p">{</span>
            <span class="n">bookService</span> <span class="p">=</span> <span class="nc">IBookManager</span><span class="p">.</span><span class="nc">Stub</span><span class="p">.</span><span class="nf">asInterface</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">binding</span> <span class="p">=</span>
            <span class="nc">DataBindingUtil</span><span class="p">.</span><span class="n">setContentView</span><span class="p">&lt;</span><span class="nc">ActivityMainBinding</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">,</span> <span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>
        <span class="c1">//绑定服务</span>
        <span class="nf">bindService</span><span class="p">(</span><span class="nc">Intent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nc">MainService</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">),</span><span class="n">connection</span><span class="p">,</span><span class="nc">Context</span><span class="p">.</span><span class="nc">BIND_AUTO_CREATE</span><span class="p">)</span>
        <span class="n">binding</span><span class="p">.</span><span class="nf">apply</span> <span class="p">{</span>
            <span class="n">btnInsert</span><span class="p">.</span><span class="n">setOnClickListener</span> 
                <span class="kd">val</span> <span class="py">book</span> <span class="p">=</span> <span class="nc">Book</span><span class="p">(</span><span class="s">"jiangker ${SystemClock.uptimeMillis()}"</span><span class="p">,</span> <span class="mi">528</span><span class="p">)</span>
                <span class="n">bookService</span><span class="o">?.</span><span class="nf">addBook</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
                <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="nc">TAG</span><span class="p">,</span> <span class="s">"addBook $book - ${book.hashCode()}"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">btnQuery</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
                <span class="n">bookService</span><span class="o">?.</span><span class="n">bookList</span><span class="o">?.</span><span class="nf">forEachIndexed</span> <span class="p">{</span><span class="n">index</span><span class="p">,</span><span class="n">book</span> <span class="p">-&gt;</span>
                    <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="nc">TAG</span><span class="p">,</span> <span class="s">"list index: $index : - : $book - ${book.hashCode()}"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<h2 id="对应的生成的java文件">
<span class="mr-2">对应的生成的Java文件</span><a href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E7%94%9F%E6%88%90%E7%9A%84java%E6%96%87%E4%BB%B6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
</pre></td>
<td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IBookManager</span> <span class="kd">extends</span> <span class="nc">IInterface</span>
<span class="o">{</span>
    <span class="cm">/** server端继承的抽象类*/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="kd">extends</span> <span class="nc">Binder</span> <span class="kd">implements</span> <span class="nc">IBookManager</span>
    <span class="o">{</span>
        <span class="c1">//binder的唯一标识</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DESCRIPTOR</span> <span class="o">=</span> <span class="s">"com.jiangker.testitem.lib.IBookManager"</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Stub</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">attachInterface</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">DESCRIPTOR</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="cm">/**
         * 判断IBinder对象是否和自己处于同一进程，如果是就直接使用，否则把服务端的IBinder包装为一个客户端所需的AIDL接口的Proxy代理对象
         */</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBookManager</span> <span class="nf">asInterface</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">obj</span><span class="o">==</span><span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">IInterface</span> <span class="n">iin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">queryLocalInterface</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(((</span><span class="n">iin</span><span class="o">!=</span><span class="kc">null</span><span class="o">)&amp;&amp;(</span><span class="n">iin</span> <span class="k">instanceof</span> <span class="nc">IBookManager</span><span class="o">)))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="o">((</span><span class="nc">IBookManager</span><span class="o">)</span><span class="n">iin</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">IBookManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//返回当前Binder对象</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">IBinder</span> <span class="nf">asBinder</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="cm">/**
         * 接收客户端传递过来的数据。运行在服务端中的Binder线程池中，当客户端发起请求时，远程请求会通过系统底层封装后交由此方法来处理
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="no">DESCRIPTOR</span><span class="o">;</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="k">case</span> <span class="nl">INTERFACE_TRANSACTION:</span>
                <span class="o">{</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="nl">TRANSACTION_getBookList:</span>
                <span class="o">{</span>
                    <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">_result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getBookList</span><span class="o">();</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeTypedList</span><span class="o">(</span><span class="n">_result</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="nl">TRANSACTION_addBook:</span>
                <span class="o">{</span>
                    <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
                    <span class="nc">Book</span> <span class="n">_arg0</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="mi">0</span><span class="o">!=</span><span class="n">data</span><span class="o">.</span><span class="na">readInt</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="n">_arg0</span> <span class="o">=</span> <span class="nc">Book</span><span class="o">.</span><span class="na">CREATOR</span><span class="o">.</span><span class="na">createFromParcel</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">_arg0</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">addBook</span><span class="o">(</span><span class="n">_arg0</span><span class="o">);</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="nl">TRANSACTION_registerListener:</span>
                <span class="o">{</span>
                    <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
                    <span class="nc">IOnNewBookArrivedListener</span> <span class="n">_arg0</span><span class="o">;</span>
                    <span class="n">_arg0</span> <span class="o">=</span> <span class="nc">IOnNewBookArrivedListener</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">readStrongBinder</span><span class="o">());</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">registerListener</span><span class="o">(</span><span class="n">_arg0</span><span class="o">);</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="nl">TRANSACTION_unRegisterListener:</span>
                <span class="o">{</span>
                    <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
                    <span class="nc">IOnNewBookArrivedListener</span> <span class="n">_arg0</span><span class="o">;</span>
                    <span class="n">_arg0</span> <span class="o">=</span> <span class="nc">IOnNewBookArrivedListener</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">readStrongBinder</span><span class="o">());</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">unRegisterListener</span><span class="o">(</span><span class="n">_arg0</span><span class="o">);</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">default</span><span class="o">:</span>
                <span class="o">{</span>
                    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Proxy</span> <span class="kd">implements</span> <span class="nc">IBookManager</span>
        <span class="o">{</span>
            <span class="kd">private</span> <span class="nc">IBinder</span> <span class="n">mRemote</span><span class="o">;</span>
            <span class="nc">Proxy</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">remote</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">mRemote</span> <span class="o">=</span> <span class="n">remote</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nd">@Override</span> 
            <span class="kd">public</span> <span class="nc">IBinder</span> <span class="nf">asBinder</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">mRemote</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getInterfaceDescriptor</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="no">DESCRIPTOR</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">//运行在客户端，会把该方法的信息参数打包发给server端，等待方法返回</span>
            <span class="nd">@Override</span> 
            <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBookList</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
                <span class="c1">//把要传递的数据写入_data</span>
                <span class="nc">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="c1">//把要接收的函数返回值写入_reply</span>
                <span class="nc">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">_result</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
                    <span class="c1">//最后使用transact方法，就可以把数据传递给Binder的server端了</span>
                    <span class="kt">boolean</span> <span class="n">_status</span> <span class="o">=</span> <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="nc">Stub</span><span class="o">.</span><span class="na">TRANSACTION_getBookList</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">_status</span> <span class="o">&amp;&amp;</span> <span class="n">getDefaultImpl</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="nf">getDefaultImpl</span><span class="o">().</span><span class="na">getBookList</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
                    <span class="n">_result</span> <span class="o">=</span> <span class="n">_reply</span><span class="o">.</span><span class="na">createTypedArrayList</span><span class="o">(</span><span class="nc">Book</span><span class="o">.</span><span class="na">CREATOR</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">_result</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addBook</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span>
            <span class="o">{</span>
                <span class="nc">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="nc">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">book</span><span class="o">!=</span><span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">_data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                        <span class="n">book</span><span class="o">.</span><span class="na">writeToParcel</span><span class="o">(</span><span class="n">_data</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">_data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="kt">boolean</span> <span class="n">_status</span> <span class="o">=</span> <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="nc">Stub</span><span class="o">.</span><span class="na">TRANSACTION_addBook</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">_status</span> <span class="o">&amp;&amp;</span> <span class="n">getDefaultImpl</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">getDefaultImpl</span><span class="o">().</span><span class="na">addBook</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerListener</span><span class="o">(</span><span class="nc">IOnNewBookArrivedListener</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span>
            <span class="o">{</span>
                <span class="nc">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="nc">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">((((</span><span class="n">listener</span><span class="o">!=</span><span class="kc">null</span><span class="o">))?(</span><span class="n">listener</span><span class="o">.</span><span class="na">asBinder</span><span class="o">()):(</span><span class="kc">null</span><span class="o">)));</span>
                    <span class="kt">boolean</span> <span class="n">_status</span> <span class="o">=</span> <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="nc">Stub</span><span class="o">.</span><span class="na">TRANSACTION_registerListener</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">_status</span> <span class="o">&amp;&amp;</span> <span class="n">getDefaultImpl</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">getDefaultImpl</span><span class="o">().</span><span class="na">registerListener</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unRegisterListener</span><span class="o">(</span><span class="nc">IOnNewBookArrivedListener</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span>
            <span class="o">{</span>
                <span class="nc">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="nc">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">((((</span><span class="n">listener</span><span class="o">!=</span><span class="kc">null</span><span class="o">))?(</span><span class="n">listener</span><span class="o">.</span><span class="na">asBinder</span><span class="o">()):(</span><span class="kc">null</span><span class="o">)));</span>
                    <span class="kt">boolean</span> <span class="n">_status</span> <span class="o">=</span> <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="nc">Stub</span><span class="o">.</span><span class="na">TRANSACTION_unRegisterListener</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">_status</span> <span class="o">&amp;&amp;</span> <span class="n">getDefaultImpl</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">getDefaultImpl</span><span class="o">().</span><span class="na">unRegisterListener</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBookManager</span> <span class="n">sDefaultImpl</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TRANSACTION_getBookList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IBinder</span><span class="o">.</span><span class="na">FIRST_CALL_TRANSACTION</span> <span class="o">+</span> <span class="mi">0</span><span class="o">);</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TRANSACTION_addBook</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IBinder</span><span class="o">.</span><span class="na">FIRST_CALL_TRANSACTION</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TRANSACTION_registerListener</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IBinder</span><span class="o">.</span><span class="na">FIRST_CALL_TRANSACTION</span> <span class="o">+</span> <span class="mi">2</span><span class="o">);</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TRANSACTION_unRegisterListener</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IBinder</span><span class="o">.</span><span class="na">FIRST_CALL_TRANSACTION</span> <span class="o">+</span> <span class="mi">3</span><span class="o">);</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">setDefaultImpl</span><span class="o">(</span><span class="nc">IBookManager</span> <span class="n">impl</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">.</span><span class="na">sDefaultImpl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">impl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">.</span><span class="na">sDefaultImpl</span> <span class="o">=</span> <span class="n">impl</span><span class="o">;</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBookManager</span> <span class="nf">getDefaultImpl</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">.</span><span class="na">sDefaultImpl</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBookList</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">RemoteException</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addBook</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerListener</span><span class="o">(</span><span class="nc">IOnNewBookArrivedListener</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unRegisterListener</span><span class="o">(</span><span class="nc">IOnNewBookArrivedListener</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span><span class="o">;</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<ul>
  <li>Stub继承至binder，需要由提供服务的一方实现，最后返回binder对象给SM</li>
  <li>Proxy是接口的代理，当Client通过asInterface(IBinder)去获取接口对象时，在同一进程会直接返回实际对象，若不在同一进程就会返回服务端Proxy的代理对象，Proxy是组合模式，会持有远程Binder的引用。</li>
  <li>当调用server的方法时，会把数据进行序列化，然后调用远程binder的transact方法来把数据写入，如何阻塞等待server的结果返回。</li>
  <li>当方法进行调用时，服务端的onTransact方法会被执行，然后根据code去解析参数然后再调用具体的方法实现，最后再把返回结果写入返回。</li>
  <li>binder的线程都为子线程。binder的调用可以在主线程执行，会阻塞等待结果返回。</li>
</ul>

<h2 id="死亡代理">
<span class="mr-2">死亡代理</span><a href="#%E6%AD%BB%E4%BA%A1%E4%BB%A3%E7%90%86" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>binder提供两个方法，通过linkToDeath就可以给Binder设置一个死亡代理，在Binder死亡时通知我们，这个触发是在客户端的Binder线程池里面的，不可以进行UI操作</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
<td class="rouge-code"><pre><span class="c1">//定义死亡代理</span>
<span class="kd">private</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">DeathRecipient</span> <span class="n">mDeathRecipient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">DeathRecipient</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">binderDied</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bookServer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
        <span class="n">bookServer</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">unlinkToDeath</span><span class="o">(</span><span class="n">mDeathRecipient</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">bookServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="c1">//            binderServer();</span>
    <span class="o">}</span>
<span class="o">};</span>
<span class="c1">//设置绑定</span>
<span class="kd">private</span> <span class="nc">ServiceConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceConnection</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisConnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">){}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span><span class="nc">IBinder</span> <span class="n">service</span><span class="o">){</span>
        <span class="n">service</span><span class="o">.</span><span class="na">linkToDeath</span><span class="o">(</span><span class="n">mDeathRecipient</span><span class="o">,</span><span class="mi">0</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>也可以在onServiceDisConnected中进行重连操作，这个是主线程中触发的</p>

<h2 id="权限校验">
<span class="mr-2">权限校验</span><a href="#%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>在服务端定义权限</p>

<div class="language-xml highlighter-rouge">
<div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">package=</span><span class="s">"com.example.sourcecode"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;permission</span> <span class="na">android:name=</span><span class="s">"com.jinagker.permission.Test"</span>
        <span class="na">android:protectionLevel=</span><span class="s">"normal"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>可以在两个地方进行拦截</p>
<ol>
  <li>onBind方法处（使用Context类的<code class="language-plaintext highlighter-rouge">checkCallingOrSelfPermission(String permission)</code>方法）
    <div class="language-kotlin highlighter-rouge">
<div class="code-header">
        <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre> <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBind</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="nc">Intent</span><span class="p">):</span> <span class="nc">IBinder</span><span class="p">?</span> <span class="p">{</span>
     <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span>
         <span class="nf">checkCallingOrSelfPermission</span><span class="p">(</span><span class="s">"com.jinagker.permission.Test"</span><span class="p">)</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">==</span> <span class="nc">PackageManager</span><span class="p">.</span><span class="nc">PERMISSION_DENIED</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span>
     <span class="k">return</span> <span class="n">messageManager</span><span class="p">.</span><span class="n">binder</span>
 <span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>    </div>
    <p>使用，需要申明权限</p>

    <div class="language-xml highlighter-rouge">
<div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre> <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"com.jinagker.permission.Test"</span><span class="nt">/&gt;</span>
</pre></td>
</tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>在服务端的onTransact中进行验证（重写服务端的onTransact方法，校验失败返回false）</p>

    <div class="language-kotlin highlighter-rouge">
<div class="code-header">
        <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td>
<td class="rouge-code"><pre> <span class="kd">val</span> <span class="py">server</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">ISaveSp</span><span class="p">.</span><span class="nc">Stub</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">override</span> <span class="k">fun</span> <span class="nf">onTransact</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nc">Parcel</span><span class="p">,</span> <span class="n">reply</span><span class="p">:</span> <span class="nc">Parcel</span><span class="p">?,</span> <span class="n">flags</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
         <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span>
             <span class="nf">checkCallingOrSelfPermission</span><span class="p">(</span><span class="s">"com.jinagker.permission.Test"</span><span class="p">)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">==</span> <span class="nc">PackageManager</span><span class="p">.</span><span class="nc">PERMISSION_DENIED</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span>
         <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">onTransact</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
     <span class="p">}</span>
 <span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>    </div>
  </li>
  <li>直接在服务端属性处增加<code class="language-plaintext highlighter-rouge">android:poermission</code>，没有申明的<code class="language-plaintext highlighter-rouge">onServiceConnected</code>不会有返回</li>
</ol>

<h2 id="messenger方式">
<span class="mr-2">Messenger方式</span><a href="#messenger%E6%96%B9%E5%BC%8F" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>Messenger其实也是对Binder的一种封装，结合handler的方式，使用message来携带消息。</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">Messenger</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mTarget</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getIMessenger</span><span class="o">();</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="nf">Messenger</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mTarget</span> <span class="o">=</span> <span class="nc">IMessenger</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>使用</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
<td class="rouge-code"><pre><span class="kd">private</span> <span class="n">val</span> <span class="n">messenger</span> <span class="o">=</span> <span class="nc">Messenger</span><span class="o">(</span><span class="nc">MessengerHandler</span><span class="o">())</span>

<span class="n">override</span> <span class="n">fun</span> <span class="nf">onBind</span><span class="o">(</span><span class="nl">intent:</span> <span class="nc">Intent</span><span class="o">):</span> <span class="nc">IBinder</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">messenger</span><span class="o">.</span><span class="na">binder</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">MessengerHandler</span> <span class="o">:</span> <span class="nc">Handler</span><span class="o">(</span><span class="nc">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nl">msg:</span> <span class="nc">Message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">when</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">MessengerActivity</span><span class="o">.</span><span class="na">CLIENT_MSG</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="c1">// replyTo也是一个messenger对象</span>
                <span class="n">val</span> <span class="n">client</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">replyTo</span>
                <span class="n">val</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="no">SERVER_MSG</span><span class="o">)</span>
                <span class="n">val</span> <span class="n">bundle</span> <span class="o">=</span> <span class="nc">Bundle</span><span class="o">()</span>
                <span class="n">bundle</span><span class="o">.</span><span class="na">putParcelable</span><span class="o">(</span><span class="s">"bitmap"</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">))</span>
                <span class="n">message</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">bundle</span>
                <span class="n">client</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">-&gt;</span> <span class="kd">super</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<h2 id="跨进程传递大图片">
<span class="mr-2">跨进程传递大图片</span><a href="#%E8%B7%A8%E8%BF%9B%E7%A8%8B%E4%BC%A0%E9%80%92%E5%A4%A7%E5%9B%BE%E7%89%87" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<ol>
  <li>对于如果图片本为本地图片的，可以直接传递文件路径。</li>
  <li>若是下载到内存中的图片，写入储存再传递路径，再在另外的进程读取，这样的方式性能很低。</li>
  <li>使用Socket、管道等方式需要两次拷贝，从用户空间到内核空间，再从内核空间到用户空间。</li>
  <li>使用binder</li>
</ol>

<p>若使用intent传递数据，数据量比较大时，会抛出异常</p>

<div class="language-kotlin highlighter-rouge">
<div class="code-header">
        <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="kd">val</span> <span class="py">intent</span> <span class="p">=</span> <span class="nc">Intent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nc">PoolService</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
<span class="n">intent</span><span class="p">.</span><span class="nf">putExtra</span><span class="p">(</span><span class="s">"bitmap"</span><span class="p">,</span><span class="nc">Bitmap</span><span class="p">.</span><span class="nf">createBitmap</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="nc">Bitmap</span><span class="p">.</span><span class="nc">Config</span><span class="p">.</span><span class="nc">ARGB_8888</span><span class="p">))</span>
<span class="nf">bindService</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="nc">Context</span><span class="p">.</span><span class="nc">BIND_AUTO_CREATE</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p><img data-src="https://material.jiangker.cn/i/2022/11/15/63735c684a3d6.png" alt="" data-proofer-ignore></p>

<p>正常情况推荐使用intent的putBinder方式来传递，然后通过binder中的bitmap方法传递数据</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.jiangker.android.ipc.pool</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.graphics.Bitmap</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">BitmapTranslate</span><span class="o">{</span>
    <span class="kt">void</span> <span class="nf">translate</span><span class="o">(</span><span class="n">in</span> <span class="nc">Bitmap</span> <span class="n">origin</span><span class="o">);</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>大致原因为intent方式传递时，系统会禁止掉文件引用符的传递方式，强制走序列化和反序列化流程。而使用binder传递时，若文件大于16kb时，会开辟一个匿名共享内存，无需拷贝，提高传递效率。</p>

<h1 id="参考">参考</h1>

<ul>
  <li><a href="https://cloud.tencent.com/developer/article/1780764">Android中怎么跨进程传输大图片</a></li>
  <li><a href="https://jishuin.proginn.com/p/763bfbd6ad2e">面试官：跨进程如何传递大图？又蒙圈了……</a></li>
</ul>

<h2 id="代码地址">
<span class="mr-2">代码地址</span><a href="#%E4%BB%A3%E7%A0%81%E5%9C%B0%E5%9D%80" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>https://gitlab.jiangker.cn/jiangker/androidipc</p>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href="/categories/android/">Android</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/ipc/" class="post-tag no-text-decoration">ipc</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Android%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1+-+Jiangker&amp;url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fipc%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Android%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1+-+Jiangker&amp;u=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fipc%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fipc%2F&text=Android%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1+-+Jiangker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div>
<!-- .post-tail-bottom -->

</div>
<!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recently Updated</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/serde_json/">使用serde解析json</a></li>
      
        
        
        
      <li><a href="/posts/zsh/">Ubuntu安装zsh</a></li>
      
        
        
        
      <li><a href="/posts/update_blog/">增加webhooks自动更新blog</a></li>
      
        
        
        
      <li><a href="/posts/rustlings/">rustlings 学习和答案</a></li>
      
        
        
        
      <li><a href="/posts/anotations/">SpringBoot常用注解</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/docker/">docker</a>
    
      
      <a class="post-tag" href="/tags/android/">android</a>
    
      
      <a class="post-tag" href="/tags/jetpack/">jetpack</a>
    
      
      <a class="post-tag" href="/tags/raspberrypi/">raspberrypi</a>
    
      
      <a class="post-tag" href="/tags/gitlab/">gitlab</a>
    
      
      <a class="post-tag" href="/tags/actix-web/">actix-web</a>
    
      
      <a class="post-tag" href="/tags/aosp/">AOSP</a>
    
      
      <a class="post-tag" href="/tags/dockerfile/">dockerfile</a>
    
      
      <a class="post-tag" href="/tags/file/">file</a>
    
      
      <a class="post-tag" href="/tags/java/">java</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/shared-preferences/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small" data-ts="1653402180" data-df="ll">
  May 24, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>SharePreferences的基础使用</h3>
            <div class="text-muted small">
              <p>
                





                获取SharedPreferences对象

要想使用SharedPrefernces储存数据，首先要获取SharedPreferences对象。主要获取方式有以下两种

Context类中的getSharedPreferences()方法

//第一个参数为储存的文件名，第二个参数是操作模式，现只有一种
val edit : SharedPreferences = getSharedPre...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/storage-path/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small" data-ts="1653402780" data-df="ll">
  May 24, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android文件目录概览</h3>
            <div class="text-muted small">
              <p>
                





                外部储存

可以在手机中直接查看的目录，目录为Android/data/&amp;lt;package name&amp;gt;/xxx 下的系列文件

  传入的参数不要以“/”开始


//主要对应`Android/data/&amp;lt;package name&amp;gt;/files/`下的文件目录,传入空则为根目录
val externalFilesDir = getExternalFilesDir("pl...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/lifecycle/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small" data-ts="1654409220" data-df="ll">
  Jun  5, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lifecycle使用以及原理解析</h3>
            <div class="text-muted small">
              <p>
                





                基础使用

在Android框架中定义的许多应用组件都存在着生命周期（例如Activity、Fragment）。组件的生命周期由操作系统中运行的框架代码管理。它们是Android工作原理的核心，应用必须遵守规则，否则会造成内存泄露以及应用的崩溃。应用中有很多组件需要在创建时注册绑定，在可见时运作，在不可见时停止，在销毁时解除绑定，许许多多的操作都与生命周期密切相关。所以这时如果需要添加到生命...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/dispatch-touch-event/" class="btn btn-outline-primary" prompt="Older">
    <p>View的事件分发机制</p>
  </a>
  

  
  <a href="/posts/jni/" class="btn btn-outline-primary" prompt="Newer">
    <p>JNI的基础使用</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>



        <!-- The Footer -->

<footer class="row pl-3 pr-3">
  <div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0">
    <div class="footer-left">
      <p class="mb-0">
        © 2024
        <a href="https://twitter.com/username">jiangker</a>.
        
        <span data-toggle="tooltip" data-placement="top" title="个人">蜀ICP备2023021215号</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        

        

        Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
         with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
         theme.

      </p>
    </div>

  </div>

</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/docker/">docker</a>
    
      
      <a class="post-tag" href="/tags/android/">android</a>
    
      
      <a class="post-tag" href="/tags/jetpack/">jetpack</a>
    
      
      <a class="post-tag" href="/tags/raspberrypi/">raspberrypi</a>
    
      
      <a class="post-tag" href="/tags/gitlab/">gitlab</a>
    
      
      <a class="post-tag" href="/tags/actix-web/">actix-web</a>
    
      
      <a class="post-tag" href="/tags/aosp/">AOSP</a>
    
      
      <a class="post-tag" href="/tags/dockerfile/">dockerfile</a>
    
      
      <a class="post-tag" href="/tags/file/">file</a>
    
      
      <a class="post-tag" href="/tags/java/">java</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    
      <!--
  mermaid-js loader
-->

<script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script>

<script>
  $(function() {
    function updateMermaid(event) {
      if (event.source === window && event.data &&
            event.data.direction === ModeToggle.ID) {

        const mode = event.data.message;

        if (typeof mermaid === "undefined") {
          return;
        }

        let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    let initTheme = "default";

    if ($("html[data-mode=dark]").length > 0
      || ($("html[data-mode]").length == 0
        && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) {
      initTheme = "dark";
    }

    let mermaidConf = {
      theme: initTheme  /* <default|dark|forest|neutral> */
    };

    /* Markdown converts to HTML */
    $("pre").has("code.language-mermaid").each(function() {
      let svgCode = $(this).children().html();
      $(this).addClass("unloaded");
      $(this).after(`<div class=\"mermaid\">${svgCode}</div>`);
    });

    mermaid.initialize(mermaidConf);

    window.addEventListener("message", updateMermaid);
  });
</script>

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>


  <!-- MathJax -->
  <script>
  /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */
  MathJax = {
    tex: {
      inlineMath: [              /* start/end delimiter pairs for in-line math */
        ['$','$'],
        ['\\(','\\)']
      ],
      displayMath: [             /* start/end delimiter pairs for display math */
        ['$$', '$$'],
        ['\\[', '\\]']
      ]
    }
  };
  </script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
  </script>


<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>
