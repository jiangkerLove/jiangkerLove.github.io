<!DOCTYPE html>
<html lang="en">

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Allow having a localized datetime different from the appearance language -->
  

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="Java虚拟机">
<meta name="author" content="jiangker">
<meta property="og:locale" content="en">
<meta name="description" content="JDK(Java Development Kit) 包含Java语言、Java虚拟机、Java Api 类库，是Java程序开发的最小环境。而JRE(Java Runtime Environment)包含了Java Api中的Java SE Api子集和Java虚拟机这两部分，是Java程序运行的标准环境。">
<meta property="og:description" content="JDK(Java Development Kit) 包含Java语言、Java虚拟机、Java Api 类库，是Java程序开发的最小环境。而JRE(Java Runtime Environment)包含了Java Api中的Java SE Api子集和Java虚拟机这两部分，是Java程序运行的标准环境。">
<link rel="canonical" href="http://0.0.0.0:4000/posts/jvm/">
<meta property="og:url" content="http://0.0.0.0:4000/posts/jvm/">
<meta property="og:site_name" content="Jiangker">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-12-05T11:28:00+08:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Java虚拟机">
<meta name="twitter:site" content="@twitter_username">
<meta name="twitter:creator" content="@jiangker">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"jiangker"},"dateModified":"2023-12-05T11:28:00+08:00","datePublished":"2023-12-05T11:28:00+08:00","description":"JDK(Java Development Kit) 包含Java语言、Java虚拟机、Java Api 类库，是Java程序开发的最小环境。而JRE(Java Runtime Environment)包含了Java Api中的Java SE Api子集和Java虚拟机这两部分，是Java程序运行的标准环境。","headline":"Java虚拟机","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/posts/jvm/"},"url":"http://0.0.0.0:4000/posts/jvm/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Java虚拟机 | Jiangker
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Jiangker">
<meta name="application-name" content="Jiangker">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net">
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&amp;display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  
</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="/assets/img/avatar.jpeg" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Jiangker</a>
    </div>
    <div class="site-subtitle font-italic">record coding learning</div>

  </div>
<!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
      <a href="javascript:location.href%20=%20'mailto:'%20+%20%5B'niklaus1996','icloud.com'%5D.join('@')" aria-label="email">
        <i class="fas fa-envelope"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div>
<!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>Java虚拟机</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel">Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">

        









<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->



<!-- images -->




  
  

  
    
      
      
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    

    

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







  
  

  

    
      
      

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

  



<!-- return -->





<h1 data-toc-skip>Java虚拟机</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="" data-ts="1701746880" data-df="ll" data-toggle="tooltip" data-placement="bottom">
  Dec  5, 2023
</em>

    </span>

    <!-- lastmod date -->
    

  

  <div class="d-flex justify-content-between">
    <!-- author -->
    <span>
      
      

      

      By

      <em>
        
        jiangker
        
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="10687 words">
  <em>59 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <blockquote class="prompt-tip"><div>
  <p>JDK(Java Development Kit) 包含Java语言、Java虚拟机、Java Api 类库，是Java程序开发的最小环境。而JRE(Java Runtime Environment)包含了Java Api中的Java SE Api子集和Java虚拟机这两部分，是Java程序运行的标准环境。</p>
</div></blockquote>

<h1 id="执行流程">执行流程</h1>

<p>java文件首先在编译环境下编译成为可以运行的<code class="language-plaintext highlighter-rouge">.class</code>文件，然后由Java虚拟机运行。java文件和虚拟机并没有直接的联系，只是特定的二进制文件，例如kotlin、Groovy等语言都可以编译成class文件，在JVM中运行。</p>

<h1 id="类加载器">类加载器</h1>

<h2 id="类与类加载器">
<span class="mr-2">类与类加载器</span><a href="#%E7%B1%BB%E4%B8%8E%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="判断类是否相等">
<span class="mr-2">判断类是否“相等”</span><a href="#%E5%88%A4%E6%96%AD%E7%B1%BB%E6%98%AF%E5%90%A6%E7%9B%B8%E7%AD%89" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>任意一个类，都由<strong>加载它的类加载器</strong>和这个<strong>类本身</strong>一同确立其在 Java 虚拟机中的唯一性，每一个类加载器，都有一个独立的类名称空间。</p>

<p>因此，比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义，否则，即使这两个类来源于同一个 Class 文件，被同一个虚拟机加载，只要加载它们的类加载器不同，那么这两个类就必定不相等。</p>

<p>这里的“相等”，包括代表类的 Class 对象的 <code class="language-plaintext highlighter-rouge">equals()</code> 方法、<code class="language-plaintext highlighter-rouge">isInstance()</code> 方法的返回结果，也包括使用 instanceof 关键字做对象所属关系判定等情况。</p>

<h3 id="加载器种类">
<span class="mr-2">加载器种类</span><a href="#%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%A7%8D%E7%B1%BB" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>系统提供了 3 种类加载器：</p>

<ul>
  <li>Bootstrap ClassLoader（引导类加载器）： 用C/C++代码实现的加载器，用于加载指定的JDK核心类库，如<code class="language-plaintext highlighter-rouge">java.lang</code>、<code class="language-plaintext highlighter-rouge">java.util</code>等系统类，目录如下：
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">&lt;JAVA_HOME&gt;\lib</code> 目录（仅按照文件名识别，如 rt.jar，名字不符合的类库即使放在 lib 目录中也不会被加载）类库加载到虚拟机内存中</li>
      <li>
<code class="language-plaintext highlighter-rouge">-Xbootclasspath</code>参数指定的目录
  Java 虚拟机的启动就是通过引导类加载器创建的一个初始类完成的。由于是由C语言实现的，所以Java代码并不能访问，但是我们可以查询某个类是否被引导类加载器加载过。</li>
    </ul>
  </li>
  <li>Extension ClassLoader（拓展类加载器）： 加载Java的拓展类，提供除了系统类之外的额外功能。
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">&lt;JAVA_HOME&gt;\lib\ext</code> 目录中的所有类库。</li>
      <li>系统属性<code class="language-plaintext highlighter-rouge">java.ext.dir</code>所指定的目录。</li>
    </ul>
  </li>
  <li>Application ClassLoader(应用程序类加载器)： 由于这个类加载器是 ClassLoader 中的 <code class="language-plaintext highlighter-rouge">getSystemClassLoader()</code> 方法的返回值，所以一般也称它为“系统类加载器”。它负责加载用户类路径（classpath）上所指定的类库，开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</li>
</ul>

<p><img data-src="../../../assets/img/blog/jvm/classloader.png" alt="image" data-proofer-ignore></p>

<p>当然，如果有必要，还可以加入自己定义的类加载器。</p>

<h2 id="双亲委派模型">
<span class="mr-2">双亲委派模型</span><a href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="什么是双亲委派模型">
<span class="mr-2">什么是双亲委派模型</span><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>双亲委派模型是描述类加载器之间的层次关系。它要求除了顶层的启动类加载器外，其余的类加载器都应当有自己的父类加载器。（父子关系一般不会以继承的关系实现，而是以组合关系来复用父加载器的代码）</p>

<h3 id="工作过程">
<span class="mr-2">工作过程</span><a href="#%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，只有当父加载器反馈自己无法完成这个加载请求（找不到所需的类）时，子加载器才会尝试自己去加载。</p>

<p>在 java.lang.ClassLoader 中的 <code class="language-plaintext highlighter-rouge">loadClass</code> 方法中实现该过程。</p>

<h3 id="为什么使用双亲委派模型">
<span class="mr-2">为什么使用双亲委派模型</span><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>像 java.lang.Object 这些存放在 rt.jar 中的类，无论使用哪个类加载器加载，最终都会委派给最顶端的启动类加载器加载，从而使得不同加载器加载的 Object 类都是同一个。</p>

<p>相反，如果没有使用双亲委派模型，由各个类加载器自行去加载的话，如果用户自己编写了一个称为 java.lang.Object 的类，并放在 classpath 下，那么系统将会出现多个不同的 Object 类，Java 类型体系中最基础的行为也就无法保证。</p>

<h1 id="类加载的时机">类加载的时机</h1>

<h2 id="类的生命周期">
<span class="mr-2">类的生命周期</span><a href="#%E7%B1%BB%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>类从被加载到虚拟机内存开始，到卸载出内存为止，它的整个生命周期包括以下 7 个阶段：</p>

<ul>
  <li>加载</li>
  <li>验证</li>
  <li>准备</li>
  <li>解析</li>
  <li>初始化</li>
  <li>使用</li>
  <li>卸载</li>
</ul>

<p>验证、准备、解析 3 个阶段统称为连接。</p>

<p><img data-src="../../../assets/img/blog/jvm/loadclass.png" alt="image" data-proofer-ignore></p>

<p>加载、验证、准备、初始化和卸载这 5 个阶段的顺序是确定的，类的加载过程必须按照这种顺序按部就班地开始（注意是“开始”，而不是“进行”或“完成”），而解析阶段则不一定：它在某些情况下可以在初始化后再开始，这是为了支持 Java 语言的运行时绑定。</p>

<h2 id="类加载过程中初始化开始的时机">
<span class="mr-2">类加载过程中“初始化”开始的时机</span><a href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BC%80%E5%A7%8B%E7%9A%84%E6%97%B6%E6%9C%BA" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>Java 虚拟机规范没有强制约束类加载过程的第一阶段（即：加载）什么时候开始，但对于“初始化”阶段，有着严格的规定。有且仅有 5 种情况必须立即对类进行“初始化”：</p>

<ul>
  <li>在遇到 new、putstatic、getstatic、invokestatic 字节码指令时，如果类尚未初始化，则需要先触发其初始化。</li>
  <li>对类进行反射调用时，如果类还没有初始化，则需要先触发其初始化。</li>
  <li>初始化一个类时，如果其父类还没有初始化，则需要先初始化父类。</li>
  <li>虚拟机启动时，用于需要指定一个包含 <code class="language-plaintext highlighter-rouge">main()</code> 方法的主类，虚拟机会先初始化这个主类。</li>
  <li>当使用 JDK 1.7 的动态语言支持时，如果一个 java.lang.invoke.MethodHandle 实例最后的解析结果为 REF_getStatic、REF_putStatic、REF_invokeStatic 的方法句柄，并且这个方法句柄所对应的类还没初始化，则需要先触发其初始化。</li>
</ul>

<p>这 5 种场景中的行为称为对一个类进行<strong>主动引用</strong>，除此之外，其它所有引用类的方式都不会触发初始化，称为<strong>被动引用</strong>。</p>

<h2 id="被动引用演示-demo">
<span class="mr-2">被动引用演示 Demo</span><a href="#%E8%A2%AB%E5%8A%A8%E5%BC%95%E7%94%A8%E6%BC%94%E7%A4%BA-demo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="demo1">
<span class="mr-2">Demo1</span><a href="#demo1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td>
<td class="rouge-code"><pre><span class="cm">/**
 * 被动引用 Demo1:
 * 通过子类引用父类的静态字段，不会导致子类初始化。
 *
 * @author ylb
 *
 */</span>
<span class="kd">class</span> <span class="nc">SuperClass</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SuperClass init!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">123</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubClass</span> <span class="kd">extends</span> <span class="nc">SuperClass</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SubClass init!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotInitialization</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">SubClass</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
        <span class="c1">// SuperClass init!</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>对于静态字段，只有直接定义这个字段的类才会被初始化，因此通过其子类来引用父类中定义的静态字段，只会触发父类的初始化而不会触发子类的初始化。</p>

<h3 id="demo2">
<span class="mr-2">Demo2</span><a href="#demo2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
<td class="rouge-code"><pre><span class="cm">/**
 * 被动引用 Demo2:
 * 通过数组定义来引用类，不会触发此类的初始化。
 *
 * @author ylb
 *
 */</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotInitialization</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SuperClass</span><span class="o">[]</span> <span class="n">superClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SuperClass</span><span class="o">[</span><span class="mi">10</span><span class="o">];</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>这段代码不会触发父类的初始化，但会触发“[L 全类名”这个类的初始化，它由虚拟机自动生成，直接继承自 java.lang.Object，创建动作由字节码指令 newarray 触发。</p>

<h3 id="demo3">
<span class="mr-2">Demo3</span><a href="#demo3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
<td class="rouge-code"><pre><span class="cm">/**
 * 被动引用 Demo3:
 * 常量在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化。
 *
 * @author ylb
 *
 */</span>
<span class="kd">class</span> <span class="nc">ConstClass</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ConstClass init!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">HELLO_BINGO</span> <span class="o">=</span> <span class="s">"Hello Bingo"</span><span class="o">;</span>

<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotInitialization</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ConstClass</span><span class="o">.</span><span class="na">HELLO_BINGO</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>编译通过之后，常量存储到 NotInitialization 类的常量池中，NotInitialization 的 Class 文件中并没有 ConstClass 类的符号引用入口，这两个类在编译成 Class 之后就没有任何联系了。</p>

<h2 id="接口的加载过程">
<span class="mr-2">接口的加载过程</span><a href="#%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>接口加载过程与类加载过程稍有不同。</p>

<p>当一个类在初始化时，要求其父类全部都已经初始化过了，但是一个接口在初始化时，并不要求其父接口全部都完成了初始化，当真正用到父接口的时候才会初始化。</p>

<h1 id="类加载的过程">类加载的过程</h1>

<p>类加载过程包括 5 个阶段：加载、验证、准备、解析和初始化。</p>

<h2 id="加载">
<span class="mr-2">加载</span><a href="#%E5%8A%A0%E8%BD%BD" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="加载的过程">
<span class="mr-2">加载的过程</span><a href="#%E5%8A%A0%E8%BD%BD%E7%9A%84%E8%BF%87%E7%A8%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>“加载”是“类加载”过程的一个阶段，不能混淆这两个名词。在加载阶段，虚拟机需要完成 3 件事：</p>

<ul>
  <li>通过类的全限定名获取该类的二进制字节流。</li>
  <li>将二进制字节流所代表的静态结构转化为方法区的运行时数据结构。</li>
  <li>在内存中创建一个代表该类的 java.lang.Class 对象，作为方法区这个类的各种数据的访问入口。</li>
</ul>

<h3 id="获取二进制字节流">
<span class="mr-2">获取二进制字节流</span><a href="#%E8%8E%B7%E5%8F%96%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AD%97%E8%8A%82%E6%B5%81" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>对于 Class 文件，虚拟机没有指明要从哪里获取、怎样获取。除了直接从编译好的 .class 文件中读取，还有以下几种方式：</p>

<ul>
  <li>从 zip 包中读取，如 jar、war 等</li>
  <li>从网络中获取，如 Applet</li>
  <li>通过动态代理技术生成代理类的二进制字节流</li>
  <li>由 JSP 文件生成对应的 Class 类</li>
  <li>从数据库中读取，如 有些中间件服务器可以选择把程序安装到数据库中来完成程序代码在集群间的分发。</li>
</ul>

<h3 id="非数组类与数组类加载比较">
<span class="mr-2">“非数组类”与“数组类”加载比较</span><a href="#%E9%9D%9E%E6%95%B0%E7%BB%84%E7%B1%BB%E4%B8%8E%E6%95%B0%E7%BB%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%AF%94%E8%BE%83" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>非数组类加载阶段可以使用系统提供的引导类加载器，也可以由用户自定义的类加载器完成，开发人员可以通过定义自己的类加载器控制字节流的获取方式（如重写一个类加载器的 <code class="language-plaintext highlighter-rouge">loadClass()</code> 方法）</li>
  <li>数组类本身不通过类加载器创建，它是由 Java 虚拟机直接创建的，再由类加载器创建数组中的元素类。</li>
</ul>

<h3 id="注意事项">
<span class="mr-2">注意事项</span><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>虚拟机规范未规定 Class 对象的存储位置，对于 HotSpot 虚拟机而言，Class 对象比较特殊，它虽然是对象，但存放在方法区中。</li>
  <li>加载阶段与连接阶段的部分内容交叉进行，加载阶段尚未完成，连接阶段可能已经开始了。但这两个阶段的开始时间仍然保持着固定的先后顺序。</li>
</ul>

<h2 id="验证">
<span class="mr-2">验证</span><a href="#%E9%AA%8C%E8%AF%81" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="验证的重要性">
<span class="mr-2">验证的重要性</span><a href="#%E9%AA%8C%E8%AF%81%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>验证阶段确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。</p>

<h3 id="验证的过程">
<span class="mr-2">验证的过程</span><a href="#%E9%AA%8C%E8%AF%81%E7%9A%84%E8%BF%87%E7%A8%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>文件格式验证 验证字节流是否符合 Class 文件格式的规范，并且能被当前版本的虚拟机处理，验证点如下：
    <ul>
      <li>是否以魔数 0XCAFEBABE 开头</li>
      <li>主次版本号是否在当前虚拟机处理范围内</li>
      <li>常量池是否有不被支持的常量类型</li>
      <li>指向常量的索引值是否指向了不存在的常量</li>
      <li>CONSTANT_Utf8_info 型的常量是否有不符合 UTF8 编码的数据</li>
      <li>……</li>
    </ul>
  </li>
  <li>元数据验证 对字节码描述信息进行语义分析，确保其符合 Java 语法规范。</li>
  <li>字节码验证 本阶段是验证过程中最复杂的一个阶段，是对方法体进行语义分析，保证方法在运行时不会出现危害虚拟机的事件。</li>
  <li>符号引用验证 本阶段发生在解析阶段，确保解析正常执行。</li>
</ul>

<h2 id="准备">
<span class="mr-2">准备</span><a href="#%E5%87%86%E5%A4%87" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>准备阶段是正式为类变量（或称“静态成员变量”）分配内存并设置初始值的阶段。这些变量（不包括实例变量）所使用的内存都在方法区中进行分配。</p>

<p>初始值“通常情况下”是数据类型的零值（0, null…），假设一个类变量的定义为：</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">123</span><span class="o">;</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>那么变量 value 在准备阶段过后的初始值为 0 而不是 123，因为这时候尚未开始执行任何 Java 方法。</p>

<p>存在“特殊情况”：如果类字段的字段属性表中存在 ConstantValue 属性，那么在准备阶段 value 就会被初始化为 ConstantValue 属性所指定的值，假设上面类变量 value 的定义变为：</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">123</span><span class="o">;</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p>那么在准备阶段虚拟机会根据 ConstantValue 的设置将 value 赋值为 123。</p>

<h2 id="解析">
<span class="mr-2">解析</span><a href="#%E8%A7%A3%E6%9E%90" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。</p>

<h2 id="初始化">
<span class="mr-2">初始化</span><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>类初始化阶段是类加载过程的最后一步，是执行类构造器 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法的过程。</p>

<p><code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块（static {} 块）中的语句合并产生的，编译器收集的顺序是由语句在源文件中出现的顺序所决定的。</p>

<p>静态语句块中只能访问定义在静态语句块之前的变量，定义在它之后的变量，在前面的静态语句块中可以赋值，但不能访问。如下方代码所示：</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  <span class="c1">// 给变量赋值可以正常编译通过</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>  <span class="c1">// 这句编译器会提示“非法向前引用”</span>
    <span class="o">}</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p><code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法不需要显式调用父类构造器，虚拟机会保证在子类的 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法执行之前，父类的 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法已经执行完毕。</p>

<p>由于父类的 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法先执行，意味着父类中定义的静态语句块要优先于子类的变量赋值操作。如下方代码所示：</p>

<div class="language-java highlighter-rouge">
<div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
<td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Parent</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">A</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="no">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">Sub</span> <span class="kd">extends</span> <span class="nc">Parent</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">B</span> <span class="o">=</span> <span class="no">A</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Sub</span><span class="o">.</span><span class="na">B</span><span class="o">);</span> <span class="c1">// 输出 2</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>

<p><code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法不是必需的，如果一个类没有静态语句块，也没有对类变量的赋值操作，那么编译器可以不为这个类生成 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法。</p>

<p>接口中不能使用静态代码块，但接口也需要通过 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法为接口中定义的静态成员变量显式初始化。但接口与类不同，接口的 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法不需要先执行父类的 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法，只有当父接口中定义的变量使用时，父接口才会初始化。</p>

<p>虚拟机会保证一个类的 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法在多线程环境中被正确加锁、同步。如果多个线程同时去初始化一个类，那么只会有一个线程去执行这个类的 <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;()</code> 方法。</p>

<h1 id="jvm-内存结构">JVM 内存结构</h1>
<p>Java 虚拟机的内存空间分为 5 个部分：</p>

<ul>
  <li>程序计数器</li>
  <li>Java 虚拟机栈</li>
  <li>本地方法栈</li>
  <li>堆</li>
  <li>方法区</li>
</ul>

<p><img data-src="../../../assets/img/blog/jvm/jvm-memory-structure.jpg" alt="image" data-proofer-ignore></p>

<p>JDK 1.8 同 JDK 1.7 比，最大的差别就是：元数据区取代了永久代。元空间的本质和永久代类似，都是对 JVM 规范中方法区的实现。不过元空间与永久代之间最大的区别在于：元数据空间并不在虚拟机中，而是使用本地内存。</p>

<h2 id="程序计数器pc-寄存器">
<span class="mr-2">程序计数器（PC 寄存器）</span><a href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8pc-%E5%AF%84%E5%AD%98%E5%99%A8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="程序计数器的定义">
<span class="mr-2">程序计数器的定义</span><a href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E5%AE%9A%E4%B9%89" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>程序计数器是一块较小的内存空间，是当前线程正在执行的那条字节码指令的地址。若当前线程正在执行的是一个本地方法，那么此时程序计数器为<code class="language-plaintext highlighter-rouge">Undefined</code>。</p>

<h3 id="程序计数器的作用">
<span class="mr-2">程序计数器的作用</span><a href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E4%BD%9C%E7%94%A8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>字节码解释器通过改变程序计数器来依次读取指令，从而实现代码的流程控制。</li>
  <li>在多线程情况下，程序计数器记录的是当前线程执行的位置，从而当线程切换回来时，就知道上次线程执行到哪了。</li>
</ul>

<h3 id="程序计数器的特点">
<span class="mr-2">程序计数器的特点</span><a href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E7%89%B9%E7%82%B9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>是一块较小的内存空间。</li>
  <li>线程私有，每条线程都有自己的程序计数器。</li>
  <li>生命周期：随着线程的创建而创建，随着线程的结束而销毁。</li>
  <li>是唯一一个不会出现<code class="language-plaintext highlighter-rouge">OutOfMemoryError</code>的内存区域。</li>
</ul>

<h2 id="java-虚拟机栈java-栈">
<span class="mr-2">Java 虚拟机栈（Java 栈）</span><a href="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88java-%E6%A0%88" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="java-虚拟机栈的定义">
<span class="mr-2">Java 虚拟机栈的定义</span><a href="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88%E7%9A%84%E5%AE%9A%E4%B9%89" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>Java 虚拟机栈是描述 Java 方法运行过程的内存模型。</p>

<p>Java 虚拟机栈会为每一个即将运行的 Java 方法创建一块叫做“栈帧”的区域，用于存放该方法运行过程中的一些信息，如：</p>

<ul>
  <li>局部变量表</li>
  <li>操作数栈</li>
  <li>动态链接</li>
  <li>方法出口信息</li>
  <li>……</li>
</ul>

<p><img data-src="../../../assets/img/blog/jvm/jvm-stack.jpg" alt="image" data-proofer-ignore></p>

<h3 id="压栈出栈过程">
<span class="mr-2">压栈出栈过程</span><a href="#%E5%8E%8B%E6%A0%88%E5%87%BA%E6%A0%88%E8%BF%87%E7%A8%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>当方法运行过程中需要创建局部变量时，就将局部变量的值存入栈帧中的局部变量表中。</p>

<p>Java 虚拟机栈的栈顶的栈帧是当前正在执行的活动栈，也就是当前正在执行的方法，PC 寄存器也会指向这个地址。只有这个活动的栈帧的本地变量可以被操作数栈使用，当在这个栈帧中调用另一个方法，与之对应的栈帧又会被创建，新创建的栈帧压入栈顶，变为当前的活动栈帧。</p>

<p>方法结束后，当前栈帧被移出，栈帧的返回值变成新的活动栈帧中操作数栈的一个操作数。如果没有返回值，那么新的活动栈帧中操作数栈的操作数没有变化。</p>

<blockquote>
  <p>由于 Java 虚拟机栈是与线程对应的，数据不是线程共享的，因此不用关心数据一致性问题，也不会存在同步锁的问题。</p>
</blockquote>

<h3 id="java-虚拟机栈的特点">
<span class="mr-2">Java 虚拟机栈的特点</span><a href="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88%E7%9A%84%E7%89%B9%E7%82%B9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>局部变量表随着栈帧的创建而创建，它的大小在编译时确定，创建时只需分配事先规定的大小即可。在方法运行过程中，局部变量表的大小不会发生改变。</li>
  <li>Java 虚拟机栈会出现两种异常：StackOverFlowError 和 OutOfMemoryError。
    <ul>
      <li>StackOverFlowError 若 Java 虚拟机栈的大小不允许动态扩展，那么当线程请求栈的深度超过当前 Java 虚拟机栈的最大深度时，抛出 StackOverFlowError 异常。</li>
      <li>OutOfMemoryError 若允许动态扩展，那么当线程请求栈时内存用完了，无法再动态扩展时，抛出 OutOfMemoryError 异常。</li>
    </ul>
  </li>
  <li>Java 虚拟机栈也是线程私有，随着线程创建而创建，随着线程的结束而销毁。</li>
</ul>

<blockquote>
  <p>出现 StackOverFlowError 时，内存空间可能还有很多。</p>
</blockquote>

<h2 id="本地方法栈">
<span class="mr-2">本地方法栈</span><a href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="本地方法栈的定义">
<span class="mr-2">本地方法栈的定义</span><a href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88%E7%9A%84%E5%AE%9A%E4%B9%89" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>本地方法栈是为 JVM 运行 Native 方法准备的空间，由于很多 Native 方法都是用 C 语言实现的，所以它通常又叫 C 栈。它与 Java 虚拟机栈实现的功能类似，只不过本地方法栈是描述本地方法运行过程的内存模型。</p>

<h3 id="栈帧变化过程">
<span class="mr-2">栈帧变化过程</span><a href="#%E6%A0%88%E5%B8%A7%E5%8F%98%E5%8C%96%E8%BF%87%E7%A8%8B" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>本地方法被执行时，在本地方法栈也会创建一块栈帧，用于存放该方法的局部变量表、操作数栈、动态链接、方法出口信息等。</p>

<p>方法执行结束后，相应的栈帧也会出栈，并释放内存空间。也会抛出 StackOverFlowError 和 OutOfMemoryError 异常。</p>

<blockquote>
  <p>如果 Java 虚拟机本身不支持 Native 方法，或是本身不依赖于传统栈，那么可以不提供本地方法栈。如果支持本地方法栈，那么这个栈一般会在线程创建的时候按线程分配。</p>
</blockquote>

<h2 id="堆">
<span class="mr-2">堆</span><a href="#%E5%A0%86" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="堆的定义">
<span class="mr-2">堆的定义</span><a href="#%E5%A0%86%E7%9A%84%E5%AE%9A%E4%B9%89" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>堆是用来存放对象的内存空间，几乎所有的对象都存储在堆中。</p>

<h3 id="堆的特点">
<span class="mr-2">堆的特点</span><a href="#%E5%A0%86%E7%9A%84%E7%89%B9%E7%82%B9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>线程共享，整个 Java 虚拟机只有一个堆，所有的线程都访问同一个堆。而程序计数器、Java 虚拟机栈、本地方法栈都是一个线程对应一个。</li>
  <li>在虚拟机启动时创建。</li>
  <li>是垃圾回收的主要场所。</li>
  <li>进一步可分为：新生代（Eden 区：<code class="language-plaintext highlighter-rouge">From Survior</code>，<code class="language-plaintext highlighter-rouge">To Survivor</code>）、老年代。</li>
</ul>

<p>不同的区域存放不同生命周期的对象，这样可以根据不同的区域使用不同的垃圾回收算法，更具有针对性。</p>

<p>堆的大小既可以固定也可以扩展，但对于主流的虚拟机，堆的大小是可扩展的，因此当线程请求分配内存，但堆已满，且内存已无法再扩展时，就抛出 OutOfMemoryError 异常。</p>

<blockquote>
  <p>Java 堆所使用的内存不需要保证是连续的。而由于堆是被所有线程共享的，所以对它的访问需要注意同步问题，方法和对应的属性都需要保证一致性。</p>
</blockquote>

<h2 id="方法区">
<span class="mr-2">方法区</span><a href="#%E6%96%B9%E6%B3%95%E5%8C%BA" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<h3 id="方法区的定义">
<span class="mr-2">方法区的定义</span><a href="#%E6%96%B9%E6%B3%95%E5%8C%BA%E7%9A%84%E5%AE%9A%E4%B9%89" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>Java 虚拟机规范中定义方法区是堆的一个逻辑部分。方法区存放以下信息：</p>

<ul>
  <li>已经被虚拟机加载的类信息</li>
  <li>常量</li>
  <li>静态变量</li>
  <li>即时编译器编译后的代码</li>
</ul>

<h3 id="方法区的特点">
<span class="mr-2">方法区的特点</span><a href="#%E6%96%B9%E6%B3%95%E5%8C%BA%E7%9A%84%E7%89%B9%E7%82%B9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>线程共享。 方法区是堆的一个逻辑部分，因此和堆一样，都是线程共享的。整个虚拟机中只有一个方法区。</li>
  <li>永久代。 方法区中的信息一般需要长期存在，而且它又是堆的逻辑分区，因此用堆的划分方法，把方法区称为“永久代”。</li>
  <li>内存回收效率低。 方法区中的信息一般需要长期存在，回收一遍之后可能只有少量信息无效。主要回收目标是：对常量池的回收；对类型的卸载。</li>
  <li>Java 虚拟机规范对方法区的要求比较宽松。 和堆一样，允许固定大小，也允许动态扩展，还允许不实现垃圾回收。</li>
</ul>

<h3 id="运行时常量池">
<span class="mr-2">运行时常量池</span><a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>方法区中存放：类信息、常量、静态变量、即时编译器编译后的代码。常量就存放在运行时常量池中。</p>

<p>当类被 Java 虚拟机加载后， .class 文件中的常量就存放在方法区的运行时常量池中。而且在运行期间，可以向常量池中添加新的常量。如 String 类的 <code class="language-plaintext highlighter-rouge">intern()</code> 方法就能在运行期间向常量池中添加字符串常量。</p>

<h2 id="直接内存堆外内存">
<span class="mr-2">直接内存（堆外内存）</span><a href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>直接内存是除 Java 虚拟机之外的内存，但也可能被 Java 使用。</p>

<h3 id="操作直接内存">
<span class="mr-2">操作直接内存</span><a href="#%E6%93%8D%E4%BD%9C%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>在 NIO 中引入了一种基于通道和缓冲的 IO 方式。它可以通过调用本地方法直接分配 Java 虚拟机之外的内存，然后通过一个存储在堆中的<code class="language-plaintext highlighter-rouge">DirectByteBuffer</code>对象直接操作该内存，而无须先将外部内存中的数据复制到堆中再进行操作，从而提高了数据操作的效率。</p>

<p>直接内存的大小不受 Java 虚拟机控制，但既然是内存，当内存不足时就会抛出 OutOfMemoryError 异常。</p>

<h3 id="直接内存与堆内存比较">
<span class="mr-2">直接内存与堆内存比较</span><a href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E4%B8%8E%E5%A0%86%E5%86%85%E5%AD%98%E6%AF%94%E8%BE%83" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<ul>
  <li>直接内存申请空间耗费更高的性能</li>
  <li>直接内存读取 IO 的性能要优于普通的堆内存。</li>
  <li>直接内存作用链： 本地 IO -&gt; 直接内存 -&gt; 本地 IO</li>
  <li>堆内存作用链：本地 IO -&gt; 直接内存 -&gt; 非直接内存 -&gt; 直接内存 -&gt; 本地 IO</li>
</ul>

<blockquote>
  <p>服务器管理员在配置虚拟机参数时，会根据实际内存设置<code class="language-plaintext highlighter-rouge">-Xmx</code>等参数信息，但经常忽略直接内存，使得各个内存区域总和大于物理内存限制，从而导致动态扩展时出现<code class="language-plaintext highlighter-rouge">OutOfMemoryError</code>异常。</p>
</blockquote>

<h1 id="垃圾收集策略与算法">垃圾收集策略与算法</h1>

<p>程序计数器、虚拟机栈、本地方法栈随线程而生，也随线程而灭；栈帧随着方法的开始而入栈，随着方法的结束而出栈。这几个区域的内存分配和回收都具有确定性，在这几个区域内不需要过多考虑回收的问题，因为方法结束或者线程结束时，内存自然就跟随着回收了。</p>

<p>而对于 Java 堆和方法区，我们只有在程序运行期间才能知道会创建哪些对象，这部分内存的分配和回收都是动态的，垃圾收集器所关注的正是这部分内存。</p>

<h2 id="判定对象是否存活">
<span class="mr-2">判定对象是否存活</span><a href="#%E5%88%A4%E5%AE%9A%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E5%AD%98%E6%B4%BB" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>若一个对象不被任何对象或变量引用，那么它就是无效对象，需要被回收。</p>

<h3 id="引用计数法">
<span class="mr-2">引用计数法</span><a href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E6%B3%95" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>在对象头维护着一个 counter 计数器，对象被引用一次则计数器 +1；若引用失效则计数器 -1。当计数器为 0 时，就认为该对象无效了。</p>

<p>引用计数算法的实现简单，判定效率也很高，在大部分情况下它都是一个不错的算法。但是主流的 Java 虚拟机里没有选用引用计数算法来管理内存，主要是因为它很难解决对象之间循环引用的问题。</p>

<blockquote>
  <p>举个栗子 👉 对象 objA 和 objB 都有字段 instance，令 objA.instance = objB 并且 objB.instance = objA，由于它们互相引用着对方，导致它们的引用计数都不为 0，于是引用计数算法无法通知 GC 收集器回收它们。</p>
</blockquote>

<h3 id="可达性分析法">
<span class="mr-2">可达性分析法</span><a href="#%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90%E6%B3%95" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>所有和 GC Roots 直接或间接关联的对象都是有效对象，和 GC Roots 没有关联的对象就是无效对象。</p>

<p>GC Roots 是指：</p>

<ul>
  <li>Java 虚拟机栈（栈帧中的本地变量表）中引用的对象</li>
  <li>本地方法栈中引用的对象</li>
  <li>方法区中常量引用的对象</li>
  <li>方法区中类静态属性引用的对象</li>
</ul>

<p>GC Roots 并不包括堆中对象所引用的对象，这样就不会有循环引用的问题。</p>

<h2 id="引用的种类">
<span class="mr-2">引用的种类</span><a href="#%E5%BC%95%E7%94%A8%E7%9A%84%E7%A7%8D%E7%B1%BB" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>判定对象是否存活与“引用”有关。在 JDK 1.2 以前，Java 中的引用定义很传统，一个对象只有被引用或者没有被引用两种状态，我们希望能描述这一类对象：当内存空间还足够时，则保留在内存中；如果内存空间在进行垃圾收集后还是非常紧张，则可以抛弃这些对象。很多系统的缓存功能都符合这样的应用场景。</p>

<p>在 JDK 1.2 之后，Java 对引用的概念进行了扩充，将引用分为了以下四种。不同的引用类型，主要体现的是对象不同的可达性状态<code class="language-plaintext highlighter-rouge">reachable</code>和垃圾收集的影响。</p>

<h3 id="强引用strong-reference">
<span class="mr-2">强引用（Strong Reference）</span><a href="#%E5%BC%BA%E5%BC%95%E7%94%A8strong-reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>类似 “Object obj = new Object()” 这类的引用，就是强引用，只要强引用存在，垃圾收集器永远不会回收被引用的对象。但是，如果我们<strong>错误地保持了强引用</strong>，比如：赋值给了 static 变量，那么对象在很长一段时间内不会被回收，会产生内存泄漏。</p>

<h3 id="软引用soft-reference">
<span class="mr-2">软引用（Soft Reference）</span><a href="#%E8%BD%AF%E5%BC%95%E7%94%A8soft-reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>软引用是一种相对强引用弱化一些的引用，可以让对象豁免一些垃圾收集，只有当 JVM 认为内存不足时，才会去试图回收软引用指向的对象。JVM 会确保在抛出 OutOfMemoryError 之前，清理软引用指向的对象。软引用通常用来<strong>实现内存敏感的缓存</strong>，如果还有空闲内存，就可以暂时保留缓存，当内存不足时清理掉，这样就保证了使用缓存的同时，不会耗尽内存。</p>

<h3 id="弱引用weak-reference">
<span class="mr-2">弱引用（Weak Reference）</span><a href="#%E5%BC%B1%E5%BC%95%E7%94%A8weak-reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>弱引用的<strong>强度比软引用更弱</strong>一些。当 JVM 进行垃圾回收时，<strong>无论内存是否充足，都会回收</strong>只被弱引用关联的对象。</p>

<h3 id="虚引用phantom-reference">
<span class="mr-2">虚引用（Phantom Reference）</span><a href="#%E8%99%9A%E5%BC%95%E7%94%A8phantom-reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>虚引用也称幽灵引用或者幻影引用，它是<strong>最弱</strong>的一种引用关系。一个对象是否有虚引用的存在，完全不会对其生存时间构成影响。它仅仅是提供了一种确保对象被 finalize 以后，做某些事情的机制，比如，通常用来做所谓的 Post-Mortem 清理机制。</p>

<h2 id="回收堆中无效对象">
<span class="mr-2">回收堆中无效对象</span><a href="#%E5%9B%9E%E6%94%B6%E5%A0%86%E4%B8%AD%E6%97%A0%E6%95%88%E5%AF%B9%E8%B1%A1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>对于可达性分析中不可达的对象，也并不是没有存活的可能。</p>

<h3 id="判定-finalize-是否有必要执行">
<span class="mr-2">判定 finalize() 是否有必要执行</span><a href="#%E5%88%A4%E5%AE%9A-finalize-%E6%98%AF%E5%90%A6%E6%9C%89%E5%BF%85%E8%A6%81%E6%89%A7%E8%A1%8C" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>JVM 会判断此对象是否有必要执行 finalize() 方法，如果对象没有覆盖 finalize() 方法，或者 finalize() 方法已经被虚拟机调用过，那么视为“没有必要执行”。那么对象基本上就真的被回收了。</p>

<p>如果对象被判定为有必要执行 finalize() 方法，那么对象会被放入一个 F-Queue 队列中，虚拟机会以较低的优先级执行这些 finalize()方法，但不会确保所有的 finalize() 方法都会执行结束。如果 finalize() 方法出现耗时操作，虚拟机就直接停止指向该方法，将对象清除。</p>

<h3 id="对象重生或死亡">
<span class="mr-2">对象重生或死亡</span><a href="#%E5%AF%B9%E8%B1%A1%E9%87%8D%E7%94%9F%E6%88%96%E6%AD%BB%E4%BA%A1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>如果在执行 finalize() 方法时，将 this 赋给了某一个引用，那么该对象就重生了。如果没有，那么就会被垃圾收集器清除。</p>

<blockquote>
  <p>任何一个对象的 finalize() 方法只会被系统自动调用一次，如果对象面临下一次回收，它的 finalize() 方法不会被再次执行，想继续在 finalize() 中自救就失效了。</p>
</blockquote>

<h2 id="回收方法区内存">
<span class="mr-2">回收方法区内存</span><a href="#%E5%9B%9E%E6%94%B6%E6%96%B9%E6%B3%95%E5%8C%BA%E5%86%85%E5%AD%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>方法区中存放生命周期较长的类信息、常量、静态变量，每次垃圾收集只有少量的垃圾被清除。方法区中主要清除两种垃圾：</p>

<ul>
  <li>废弃常量</li>
  <li>无用的类</li>
</ul>

<h3 id="判定废弃常量">
<span class="mr-2">判定废弃常量</span><a href="#%E5%88%A4%E5%AE%9A%E5%BA%9F%E5%BC%83%E5%B8%B8%E9%87%8F" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>只要常量池中的常量不被任何变量或对象引用，那么这些常量就会被清除掉。比如，一个字符串 “bingo” 进入了常量池，但是当前系统没有任何一个 String 对象引用常量池中的 “bingo” 常量，也没有其它地方引用这个字面量，必要的话，”bingo”常量会被清理出常量池。</p>

<h3 id="判定无用的类">
<span class="mr-2">判定无用的类</span><a href="#%E5%88%A4%E5%AE%9A%E6%97%A0%E7%94%A8%E7%9A%84%E7%B1%BB" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>判定一个类是否是“无用的类”，条件较为苛刻。</p>

<ul>
  <li>该类的所有对象都已经被清除</li>
  <li>加载该类的 ClassLoader 已经被回收</li>
  <li>该类的 java.lang.Class 对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</li>
</ul>

<blockquote>
  <p>一个类被虚拟机加载进方法区，那么在堆中就会有一个代表该类的对象：java.lang.Class。这个对象在类被加载进方法区时创建，在方法区该类被删除时清除。</p>
</blockquote>

<h2 id="垃圾收集算法">
<span class="mr-2">垃圾收集算法</span><a href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>学会了如何判定无效对象、无用类、废弃常量之后，剩余工作就是回收这些垃圾。常见的垃圾收集算法有以下几个：</p>

<h3 id="标记-清除算法">
<span class="mr-2">标记-清除算法</span><a href="#%E6%A0%87%E8%AE%B0-%E6%B8%85%E9%99%A4%E7%AE%97%E6%B3%95" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p><strong>标记</strong>的过程是：遍历所有的 <code class="language-plaintext highlighter-rouge">GC Roots</code>，然后将所有 <code class="language-plaintext highlighter-rouge">GC Roots</code> 可达的对象<strong>标记为存活的对象</strong>。</p>

<p><strong>清除</strong>的过程将遍历堆中所有的对象，将没有标记的对象全部清除掉。与此同时，清除那些被标记过的对象的标记，以便下次的垃圾回收。</p>

<p>这种方法有两个<strong>不足</strong>：</p>

<ul>
  <li>效率问题：标记和清除两个过程的效率都不高。</li>
  <li>空间问题：标记清除之后会产生大量不连续的内存碎片，碎片太多可能导致以后需要分配较大对象时，无法找到足够的连续内存而不得不提前触发另一次垃圾收集动作。</li>
</ul>

<h3 id="复制算法新生代">
<span class="mr-2">复制算法（新生代）</span><a href="#%E5%A4%8D%E5%88%B6%E7%AE%97%E6%B3%95%E6%96%B0%E7%94%9F%E4%BB%A3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>为了解决效率问题，“复制”收集算法出现了。它将可用内存按容量划分为大小相等的两块，每次只使用其中的一块。当这一块内存用完，需要进行垃圾收集时，就将存活者的对象复制到另一块上面，然后将第一块内存全部清除。这种算法有优有劣：</p>

<ul>
  <li>优点：不会有内存碎片的问题。</li>
  <li>缺点：内存缩小为原来的一半，浪费空间。</li>
</ul>

<p>为了解决空间利用率问题，可以将内存分为三块： Eden、From Survivor、To Survivor，比例是 8:1:1，每次使用 Eden 和其中一块 Survivor。回收时，将 Eden 和 Survivor 中还存活的对象一次性复制到另外一块 Survivor 空间上，最后清理掉 Eden 和刚才使用的 Survivor 空间。这样只有 10% 的内存被浪费。</p>

<p>但是我们无法保证每次回收都只有不多于 10% 的对象存活，当 Survivor 空间不够，需要依赖其他内存（指老年代）进行分配担保。</p>

<h4 id="分配担保">
<span class="mr-2">分配担保</span><a href="#%E5%88%86%E9%85%8D%E6%8B%85%E4%BF%9D" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>

<p>为对象分配内存空间时，如果 Eden+Survivor 中空闲区域无法装下该对象，会触发 MinorGC 进行垃圾收集。但如果 Minor GC 过后依然有超过 10% 的对象存活，这样存活的对象直接通过分配担保机制进入老年代，然后再将新对象存入 Eden 区。</p>

<h3 id="标记-整理算法老年代">
<span class="mr-2">标记-整理算法（老年代）</span><a href="#%E6%A0%87%E8%AE%B0-%E6%95%B4%E7%90%86%E7%AE%97%E6%B3%95%E8%80%81%E5%B9%B4%E4%BB%A3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p><strong>标记</strong>：它的第一个阶段与<strong>标记/清除算法</strong>是一模一样的，均是遍历 <code class="language-plaintext highlighter-rouge">GC Roots</code>，然后将存活的对象标记。</p>

<p><strong>整理</strong>：移动所有<strong>存活的对象</strong>，且按照内存地址次序依次排列，然后将末端内存地址以后的内存全部回收。因此，第二阶段才称为整理阶段。</p>

<p>这是一种老年代的垃圾收集算法。老年代的对象一般寿命比较长，因此每次垃圾回收会有大量对象存活，如果采用复制算法，每次需要复制大量存活的对象，效率很低。</p>

<h3 id="分代收集算法">
<span class="mr-2">分代收集算法</span><a href="#%E5%88%86%E4%BB%A3%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>

<p>根据对象存活周期的不同，将内存划分为几块。一般是把 Java 堆分为新生代和老年代，针对各个年代的特点采用最适当的收集算法。</p>

<ul>
  <li>新生代：复制算法</li>
  <li>老年代：标记-清除算法、标记-整理算法</li>
</ul>

<h1 id="内存分配与回收策略">内存分配与回收策略</h1>

<p>对象的内存分配，就是在堆上分配（也可能经过 JIT 编译后被拆散为标量类型并间接在栈上分配），对象主要分配在新生代的 Eden 区上，少数情况下可能直接分配在老年代，<strong>分配规则不固定</strong>，取决于当前使用的垃圾收集器组合以及相关的参数配置。</p>

<p>以下列举几条最普遍的内存分配规则，供大家学习。</p>

<h2 id="对象优先在-eden-分配">
<span class="mr-2">对象优先在 Eden 分配</span><a href="#%E5%AF%B9%E8%B1%A1%E4%BC%98%E5%85%88%E5%9C%A8-eden-%E5%88%86%E9%85%8D" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>大多数情况下，对象在新生代 Eden 区中分配。当 Eden 区没有足够空间进行分配时，虚拟机将发起一次 Minor GC。</p>

<p>👇<strong>Minor GC</strong> vs <strong>Major GC</strong>/<strong>Full GC</strong>：</p>

<ul>
  <li>Minor GC：回收新生代（包括 Eden 和 Survivor 区域），因为 Java 对象大多都具备朝生夕灭的特性，所以 Minor GC 非常频繁，一般回收速度也比较快。</li>
  <li>Major GC / Full GC: 回收老年代，出现了 Major GC，经常会伴随至少一次的 Minor GC，但这并非绝对。Major GC 的速度一般会比 Minor GC 慢 10 倍 以上。</li>
</ul>

<blockquote>
  <p>在 JVM 规范中，Major GC 和 Full GC 都没有一个正式的定义，所以有人也简单地认为 Major GC 清理老年代，而 Full GC 清理整个内存堆。</p>
</blockquote>

<h2 id="大对象直接进入老年代">
<span class="mr-2">大对象直接进入老年代</span><a href="#%E5%A4%A7%E5%AF%B9%E8%B1%A1%E7%9B%B4%E6%8E%A5%E8%BF%9B%E5%85%A5%E8%80%81%E5%B9%B4%E4%BB%A3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>大对象是指需要大量连续内存空间的 Java 对象，如很长的字符串或数据。</p>

<p>一个大对象能够存入 Eden 区的概率比较小，发生分配担保的概率比较大，而分配担保需要涉及大量的复制，就会造成效率低下。</p>

<p>虚拟机提供了一个 -XX:PretenureSizeThreshold 参数，令大于这个设置值的对象直接在老年代分配，这样做的目的是避免在 Eden 区及两个 Survivor 区之间发生大量的内存复制。（还记得吗，新生代采用复制算法回收垃圾）</p>

<h2 id="长期存活的对象将进入老年代">
<span class="mr-2">长期存活的对象将进入老年代</span><a href="#%E9%95%BF%E6%9C%9F%E5%AD%98%E6%B4%BB%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%B0%86%E8%BF%9B%E5%85%A5%E8%80%81%E5%B9%B4%E4%BB%A3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>JVM 给每个对象定义了一个对象年龄计数器。当新生代发生一次 Minor GC 后，存活下来的对象年龄 +1，当年龄超过一定值时，就将超过该值的所有对象转移到老年代中去。</p>

<p>使用 -XXMaxTenuringThreshold 设置新生代的最大年龄，只要超过该参数的新生代对象都会被转移到老年代中去。</p>

<h2 id="动态对象年龄判定">
<span class="mr-2">动态对象年龄判定</span><a href="#%E5%8A%A8%E6%80%81%E5%AF%B9%E8%B1%A1%E5%B9%B4%E9%BE%84%E5%88%A4%E5%AE%9A" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>如果当前新生代的 Survivor 中，相同年龄所有对象大小的总和大于 Survivor 空间的一半，年龄 &gt;= 该年龄的对象就可以直接进入老年代，无须等到 MaxTenuringThreshold 中要求的年龄。</p>

<h2 id="空间分配担保">
<span class="mr-2">空间分配担保</span><a href="#%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E6%8B%85%E4%BF%9D" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>

<p>JDK 6 Update 24 之前的规则是这样的：<br>
在发生 Minor GC 之前，虚拟机会先检查<strong>老年代最大可用的连续空间是否大于新生代所有对象总空间</strong>， 如果这个条件成立，Minor GC 可以确保是安全的； 如果不成立，则虚拟机会查看 HandlePromotionFailure 值是否设置为允许担保失败， 如果是，那么会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小， 如果大于，将尝试进行一次 Minor GC,尽管这次 Minor GC 是有风险的； 如果小于，或者 HandlePromotionFailure 设置不允许冒险，那此时也要改为进行一次 Full GC。</p>

<p>JDK 6 Update 24 之后的规则变为：<br>
只要老年代的连续空间大于新生代对象总大小或者历次晋升的平均大小，就会进行 Minor GC，否则将进行 Full GC。</p>

<p>通过清除老年代中废弃数据来扩大老年代空闲空间，以便给新生代作担保。</p>

<p>这个过程就是分配担保。</p>

<hr>

<p>👇 总结一下有哪些情况可能会触发 JVM 进行 Full GC。</p>

<ol>
  <li>
    <p>System.gc() 方法的调用<br>
此方法的调用是建议 JVM 进行 Full GC，注意这<strong>只是建议而非一定</strong>，但在很多情况下它会触发 Full GC，从而增加 Full GC 的频率。通常情况下我们只需要让虚拟机自己去管理内存即可，我们可以通过 -XX:+ DisableExplicitGC 来禁止调用 System.gc()。</p>
  </li>
  <li>
    <p>老年代空间不足<br>
老年代空间不足会触发 Full GC 操作，若进行该操作后空间依然不足，则会抛出如下错误：<br>
<code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError: Java heap space</code></p>
  </li>
  <li>
    <p>永久代空间不足<br>
JVM 规范中运行时数据区域中的方法区，在 HotSpot 虚拟机中也称为永久代（Permanet Generation），存放一些类信息、常量、静态变量等数据，当系统要加载的类、反射的类和调用的方法较多时，永久代可能会被占满，会触发 Full GC。如果经过 Full GC 仍然回收不了，那么 JVM 会抛出如下错误信息：<br>
<code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError: PermGen space </code></p>
  </li>
  <li>
    <p>CMS GC 时出现 promotion failed 和 concurrent mode failure<br>
promotion failed，就是上文所说的担保失败，而 concurrent mode failure 是在执行 CMS GC 的过程中同时有对象要放入老年代，而此时老年代空间不足造成的。</p>
  </li>
  <li>
    <p>统计得到的 Minor GC 晋升到旧生代的平均大小大于老年代的剩余空间</p>
  </li>
</ol>


</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href="/categories/java/">Java</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/jvm/" class="post-tag no-text-decoration">JVM</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Java%E8%99%9A%E6%8B%9F%E6%9C%BA+-+Jiangker&amp;url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fjvm%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Java%E8%99%9A%E6%8B%9F%E6%9C%BA+-+Jiangker&amp;u=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fjvm%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fjvm%2F&text=Java%E8%99%9A%E6%8B%9F%E6%9C%BA+-+Jiangker" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div>
<!-- .post-tail-bottom -->

</div>
<!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recently Updated</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/open_cv/">OpenCV 图像操作</a></li>
      
        
        
        
      <li><a href="/posts/rustlings/">rustlings 学习和答案</a></li>
      
        
        
        
      <li><a href="/posts/serde_json/">使用serde解析json</a></li>
      
        
        
        
      <li><a href="/posts/zsh/">Ubuntu安装zsh</a></li>
      
        
        
        
      <li><a href="/posts/update_blog/">增加webhooks自动更新blog</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/docker/">docker</a>
    
      
      <a class="post-tag" href="/tags/android/">android</a>
    
      
      <a class="post-tag" href="/tags/jetpack/">jetpack</a>
    
      
      <a class="post-tag" href="/tags/raspberrypi/">raspberrypi</a>
    
      
      <a class="post-tag" href="/tags/gitlab/">gitlab</a>
    
      
      <a class="post-tag" href="/tags/actix-web/">actix-web</a>
    
      
      <a class="post-tag" href="/tags/aosp/">AOSP</a>
    
      
      <a class="post-tag" href="/tags/dockerfile/">dockerfile</a>
    
      
      <a class="post-tag" href="/tags/file/">file</a>
    
      
      <a class="post-tag" href="/tags/java/">java</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/reflex/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small" data-ts="1656505980" data-df="ll">
  Jun 29, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java反射的使用</h3>
            <div class="text-muted small">
              <p>
                





                Class定义

@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@interface AnnotationA {

}

@AnnotationA
public class A {

    private String value1;
    public String value2;

    private ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/javapoet/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small" data-ts="1661560980" data-df="ll">
  Aug 27, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>JavaPoet的使用和示例</h3>
            <div class="text-muted small">
              <p>
                





                JavaPoet的使用和示例

JavaPoet使用面向对象的方式来构建类，其中主要分为三个部分，类，属性和方法。一般构建顺序为先属性，再方法，最后创建类的时候把前面创建的属性和方法都添加到类中即可。

导入依赖

implementation 'com.squareup:javapoet:1.13.0'


关键API

Type &amp;amp;&amp;amp; TypeName

Type

Ty...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/java-closure/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small" data-ts="1661835600" data-df="ll">
  Aug 30, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>java匿名内部类不能修改外部闭包参数</h3>
            <div class="text-muted small">
              <p>
                





                闭包中的变量一般为局部变量，若是int这种基础变量类型的以及String这种特殊类型的变量。变量是创建在栈上的。当传入这种类型的参数时，相当于重新拷贝了一份对象的引用到内部类中。此时参数也并非和外部类相同的引用了，只是指向同一个地址而已，所以只能去修改指向对象的属性，而不能修改其指向。

public class UndefineTest {

    private String name...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/singleton_pattern/" class="btn btn-outline-primary" prompt="Older">
    <p>单例模式</p>
  </a>
  

  
  <a href="/posts/disign_principle/" class="btn btn-outline-primary" prompt="Newer">
    <p>设计模式原则</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>



        <!-- The Footer -->

<footer class="row pl-3 pr-3">
  <div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0">
    <div class="footer-left">
      <p class="mb-0">
        © 2024
        <a href="https://twitter.com/username">jiangker</a>.
        
        <span data-toggle="tooltip" data-placement="top" title="个人">蜀ICP备2023021215号</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        

        

        Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
         with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
         theme.

      </p>
    </div>

  </div>

</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/docker/">docker</a>
    
      
      <a class="post-tag" href="/tags/android/">android</a>
    
      
      <a class="post-tag" href="/tags/jetpack/">jetpack</a>
    
      
      <a class="post-tag" href="/tags/raspberrypi/">raspberrypi</a>
    
      
      <a class="post-tag" href="/tags/gitlab/">gitlab</a>
    
      
      <a class="post-tag" href="/tags/actix-web/">actix-web</a>
    
      
      <a class="post-tag" href="/tags/aosp/">AOSP</a>
    
      
      <a class="post-tag" href="/tags/dockerfile/">dockerfile</a>
    
      
      <a class="post-tag" href="/tags/file/">file</a>
    
      
      <a class="post-tag" href="/tags/java/">java</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    
      <!--
  mermaid-js loader
-->

<script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script>

<script>
  $(function() {
    function updateMermaid(event) {
      if (event.source === window && event.data &&
            event.data.direction === ModeToggle.ID) {

        const mode = event.data.message;

        if (typeof mermaid === "undefined") {
          return;
        }

        let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    let initTheme = "default";

    if ($("html[data-mode=dark]").length > 0
      || ($("html[data-mode]").length == 0
        && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) {
      initTheme = "dark";
    }

    let mermaidConf = {
      theme: initTheme  /* <default|dark|forest|neutral> */
    };

    /* Markdown converts to HTML */
    $("pre").has("code.language-mermaid").each(function() {
      let svgCode = $(this).children().html();
      $(this).addClass("unloaded");
      $(this).after(`<div class=\"mermaid\">${svgCode}</div>`);
    });

    mermaid.initialize(mermaidConf);

    window.addEventListener("message", updateMermaid);
  });
</script>

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>


  <!-- MathJax -->
  <script>
  /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */
  MathJax = {
    tex: {
      inlineMath: [              /* start/end delimiter pairs for in-line math */
        ['$','$'],
        ['\\(','\\)']
      ],
      displayMath: [             /* start/end delimiter pairs for display math */
        ['$$', '$$'],
        ['\\[', '\\]']
      ]
    }
  };
  </script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
  </script>


<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>
